{% extends "base.html" %}
{% block title %}My Cart{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-6xl">

  <h1 class="text-3xl font-bold mb-6">My Cart</h1>

  {% if cart %}

  <div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="w-full border-collapse">

      <!-- HEADER -->
      <thead class="bg-gray-100 text-sm font-semibold text-gray-700">
        <tr>
          <th class="p-4 text-left w-1/2">Product</th>
          <th class="p-4 text-center w-1/6">Price</th>
          <th class="p-4 text-center w-1/6">Quantity</th>
          <th class="p-4 text-right w-1/6">Total</th>
        </tr>
      </thead>

      <!-- BODY -->
      <tbody>
        {% for item in cart.items.all %}
          {% with item.product.variants.first as variant %}
          <tr class="border-b">

            <!-- PRODUCT -->
            <td class="p-4">
              <div class="flex items-center gap-3">
                {% with item.product.images.first as image %}
                  {% if image %}
                    <img
                      src="{{ image.image.url }}"
                      alt="{{ item.product.name }}"
                      style="width:40px; height:40px; object-fit:cover;"
                      class="rounded border"
                    />
                    <div class="flex-grow">
                    <a
                      href="{% url 'products:product_detail' item.product.id item.product.slug %}"
                      class="text-blue-600 hover:underline"
                    >
                      {{ item.product.name }}
                    </a>
                  {% endif %}

                  </div>
                {% endwith %}

   
              </div>
            </td>

            <!-- PRICE -->
            <td class="p-4 text-center text-sm">
              {% if variant %}
                Rs {{ variant.price }}
              {% else %}
                —
              {% endif %}
            </td>

            <!-- QUANTITY -->
            <td class="p-4 text-center">
              <div class="flex items-center justify-center gap-3">

                <!-- Minus -->
                <button
                  class="px-3 py-1 bg-gray-200 rounded text-lg font-bold"
                  onclick="updateCart('{% url 'carts:cart_decrease' item.product.id %}')"
                >−</button>

                <!-- Quantity -->
                <span
                  id="qty-{{ item.product.id }}"
                  class="font-semibold w-6 text-center"
                >
                  {{ item.quantity }}
                </span>

                <!-- Plus -->
                <button
                  class="px-3 py-1 bg-gray-200 rounded text-lg font-bold"
                  onclick="updateCart('{% url 'carts:cart_add' item.product.id %}')"
                >+</button>

              </div>
            </td>

            <!-- TOTAL -->
            <td
            class="p-4 text-right text-sm font-semibold"
            id="item-total-{{ item.product.id }}"
          >
            Rs {{ item.get_total_price }}
          </td>
          </tr>
          {% endwith %}
        {% endfor %}
      </tbody>

    </table>

  </div>

  <!-- SUBTOTAL -->
  <div class="flex justify-end mt-6">
    <div class="bg-gray-100 p-5 rounded-lg shadow-sm w-full max-w-sm">
        <div class="flex justify-between text-lg font-bold tabular-nums"></div>
      <div class="flex justify-between text-lg font-bold">
        <span>Subtotal</span>
        <span id="cart-total">Rs {{ cart.get_total_cost }}</span>
      </div>
    </div>
  </div>
        <form method="post" action="{% url 'orders:order_created' %}">
        {% csrf_token %}
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded mt-4">
          Buy Now
      </form>

<script>
function updateCart(url) {
  fetch(url, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "X-Requested-With": "XMLHttpRequest"
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const productId = url.split("/").slice(-2, -1)[0]

      if (data.quantity > 0) {
        document.getElementById(`qty-${productId}`).innerText = data.quantity
        document.getElementById(`item-total-${productId}`).innerText = "Rs " + data.item_total
      } else {
        location.reload()  // item removed
      }

      document.getElementById("cart-total").innerText = "Rs " + data.cart_total
    }
  })
}
</script>
  {% else %}
    <p class="text-center text-gray-500">Your cart is empty.</p>
  {% endif %}

</div>
{% endblock %}
